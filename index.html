<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player M3U</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0-alpha1/css/bootstrap.min.css">
    <style>
        .carousel-item {
            display: block;
            height: 100%;
        }

        .carousel-inner {
            height: 500px;
        }

        .carousel-inner video {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }

        #player {
            max-width: 100%;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1>Player M3U</h1>
    <div class="row">
        <div class="col-md-8">
            <div id="carouselExample" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner" id="carousel"></div>
            </div>
        </div>
        <div class="col-md-4">
            <div id="player" class="embed-responsive embed-responsive-16by9"></div>
        </div>
    </div>
</div>

<script>
    const carousel = document.getElementById('carousel');
    const player = document.getElementById('player');
    let playlistData = [];

    // Função para processar o arquivo M3U
    function processPlaylist(playlist) {
        carousel.innerHTML = '';
        player.innerHTML = '';
        playlistData = [];

        var playlistLines = playlist.split('\n').filter(line => line.trim() !== '' && !line.startsWith('#EXTM3U'));

        var currentTitle = '';
        var currentLogo = '';

        playlistLines.forEach((line, index) => {
            if (line.startsWith('#EXTINF:')) {
                // Captura o nome do canal/programa (se presente) no atributo tvg-name
                let nameMatch = line.match(/tvg-name="([^"]+)"/);
                currentTitle = nameMatch ? nameMatch[1] : `Canal ${index}`;

                let logoMatch = line.match(/tvg-logo="([^"]+)"/);
                currentLogo = logoMatch ? logoMatch[1] : '';
            } else if (line.startsWith('http')) {
                var url = line.trim();

                // Adicionar "/live/" após a porta, se houver
                url = url.replace(/(https?:\/\/[^\/:]+:\d+)(\/|$)/, '$1/live/');

                // Verificar se já tem uma extensão
                let hasExtension = url.match(/\.(mp4|m3u8|ts|mkv|avi|mov|flv|wmv|webm)$/i);
                if (!hasExtension) {
                    url += '.m3u8';
                }

                playlistData.push({
                    url: url,
                    title: currentTitle,  // Usa o nome do canal ou do programa
                    logo: currentLogo
                });

                currentTitle = '';  // Resetar o título após adicionar à lista
                currentLogo = '';   // Resetar o logo após adicionar à lista
            }
        });

        renderPlaylistButtons();
        initializeCarousel();
    }

    // Função para renderizar os botões da playlist
    function renderPlaylistButtons() {
        playlistData.forEach((data, index) => {
            const button = document.createElement('button');
            button.classList.add('btn', 'btn-outline-primary', 'm-2');
            button.innerHTML = `<img src="${data.logo}" alt="Logo" width="20" height="20"> ${data.title}`;
            button.addEventListener('click', () => playStream(data.url));
            carousel.appendChild(button);
        });
    }

    // Função para inicializar o carousel
    function initializeCarousel() {
        if (playlistData.length > 0) {
            const firstStream = playlistData[0];
            playStream(firstStream.url);
        }
    }

    // Função para tocar o stream
    function playStream(url) {
        player.innerHTML = `<video id="videoPlayer" class="embed-responsive-item" controls autoplay>
                                <source src="${url}" type="application/x-mpegURL">
                                Seu navegador não suporta este formato de vídeo.
                            </video>`;
    }

    // Exemplo de como carregar o arquivo M3U (substitua por seu conteúdo real)
    const exampleM3U = `#EXTM3U
    #EXTINF:-1 tvg-name="Acompanhe a Casa" tvg-logo="https://example.com/logo1.png",Acompanhe a Casa
    http://example.com/stream1.m3u8
    #EXTINF:-1 tvg-name="Filme X" tvg-logo="https://example.com/logo2.png",Filme X
    http://example.com/stream2.m3u8`;

    processPlaylist(exampleM3U);
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0-alpha1/js/bootstrap.bundle.min.js"></script>
</body>
</html>
